<html>

<head>
    <meta charset="utf-8">
    <title>Roads I've Travelled</title>

    <!-- In <head> -->
    <link href="nouislider.min.css" rel="stylesheet">



    <script src='https://api.mapbox.com/mapbox.js/v2.2.4/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />

    <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>


    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />

    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>

    <link href='https://fonts.googleapis.com/css?family=Roboto:400,700' rel='stylesheet' type='text/css'>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/0.9.0/simple_statistics.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/1.10.0/d3-legend.min.js"></script>

    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="d3.geo.tile.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            top: 0;
            bottom: 0;
            left: 0;
            width: 67%;
            background: whitesmoke;
            font-family: "Robato", sans-serif;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        
        .info {
            padding: 8px 15px;
            font-size: 1em;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-radius: 3px;
            text-align: right;
            max-width: 300px;
        }
        
        .info h3 {
            margin: 0;
            font-size: 0.8em
        }
        
        #ui-controls {
            position: absolute;
            bottom: 3%;
            width: 90%;
            padding: 8px 15px 8px 15px;
            background: rgba(75, 75, 75, 0.8);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            color: whitesmoke;
        }
        /*        add the year-slider element*/
        
        .year-slider {
            width: 100%;
        }
        
        #ui-controls .min {
            float: left;
        }
        
        #ui-controls .max {
            float: right;
        }
        /*
        #info {
            padding: 8px 15px;
            background: whitesmoke;
            border: 2px solid #1C9976;
            border-radius: 3px;
            color: #1C9976;
            position: absolute;
            font-size: 1em;
            max-width: 200px;
            display: none;
            so doesn't appear when page loads 

        }
        
        #info p {
            margin: 3px 0 4px;
        }
        
        #info span:last-child {
            font-size: 1.3em;
            font-weight: 500;
        }
*/
        
        #side-panel {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 25%;
            background: whitesmoke;
            border-left: 2px solid #1C9976;
            overflow-y: scroll;
        }
        
        h1 {
            padding: 8px 25px 8px 15px;
            margin: 0;
            background: grey;
            color: black;
            font-weight: 700;
            font-size: 1.5em;
            text-align: center;
        }
        
        h2 {
            margin: 0;
            padding: 8px 25px 8px 15px;
            color: #626e60;
            font-weight: 700;
            font-size: 1.2em;
            text-align: right;
        }
        
        #side-panel p {
            margin: 8px 0 4px;
            padding: 0 25px 0 15px;
            color: #677077;
            text-align: right;
            font-size: 1em;
            font-weight: 400;
            bottom: 5%;
        }
        
        #side-panel p:after {
            content: '';
            display: block;
            clear: both;
        }
        
        #side-panel img {
            float: right;
            margin: 0 0 15px 15px;
        }
        
        .leaflet-overlay-pane path {
            transition: stroke .8s;
        }
        /* For this slider, disable the 'origin' size. */
        
        #connect .noUi-origin {
            right: auto;
            width: 0;
        }
        /* Position the bar and color it. */
        
        #connect .connect {
            position: absolute;
            top: 0;
            bottom: 0;
            background: #80C9F5;
            box-shadow: inset 0 0 3px rgba(51, 51, 51, 0.45);
        }
        /* When the slider is moved by tap,
   transition the connect bar like the handle. */
        
        #connect.noUi-state-tap .connect {
            -webkit-transition: left 300ms, right 300ms;
            transition: left 300ms, right 300ms;
        }
    </style>
</head>


<body>
    <div id='map'></div>
    <div id='side-panel'>

        


        <h1>Roads I've Travelled</h1>
        <h2>An interactive web map</h2>
        <p>This interactive map is a spatial diary of various routes through space that I have travelled by car. The collection of road trips details the places and life events that have made me who I am. </p>        <p>Use the slider bar below to see which year I have travelled certain roadways. Moving your mouse over a particular road will show you more information about my trip.</p>
        
        <div id='info'></div>

        <!--            need to add a info box here that shows the current highlighted year-->
        <div id='ui-controls'>
            <label>
                <!-- In <body> -->
                <script src="nouislider.min.js"></script>
                <div id='connect'></div>


                <span class="min">1986</span><span class="max">2016</span>
                <input type="range" min="1986" , max="2016" , value="1986" , step="1" , class="year-slider">
            </label>
        </div>
    </div>

    <script src="routes.geojson" type="text/javascript"></script>
    <script src="roadssample.geojson" type="text/javascript"></script>

    <script>
        var connectSlider = document.getElementById('connect');

        noUiSlider.create(connectSlider, {
            start: [1986, 2016]
            , connect: true
            , step: 1
            , range: {
                'min': 1986
                , 'max': 2016
            }
        });

        var connectBar = document.createElement('div')
            , connectBase = connectSlider.querySelector('.noUi-base');

        // Give the bar a class for styling and add it to the slider.
        connectBar.className += 'connect';
        connectBase.appendChild(connectBar);

        connectSlider.noUiSlider.on('update', function (values, handle, a, b, handlePositions) {
            
            var offset = handlePositions[handle];

            // Right offset is 100% - left offset
            if (handle === 1) {
                offset = 100 - offset;
            }
            
//            console.log(connectSlider.noUiSlider.get());
            
            var value = []
            
            value = connectSlider.noUiSlider.get()
            
            
//            var value = connectSlider.noUiSLider.get();
            
//            console.log(value[0]);
            
//            console.log(offset);

            // Pick left for the first handle, right for the second.
            connectBar.style[handle ? 'right' : 'left'] = offset + '%';
        });

        var positionsStepped = document.getElementById('pips-positions-stepped');

        var range_all_sliders = {
            'min': [1986]
            , '10%': [1989]
            , '50%': [1995, 2010]
            , 'max': [2016]
        };






        var attribute = "1986" // set a default attribute where the slider starts

        //            var labels = {
        //                    "YEAR": "YEAR"
        //                    , "2000": "2000"
        //                    , "2001": "2001"
        //                    , "2002": "2002"
        //                    , "2003": "2003"
        //                    , "2004": "2004"
        //                    , "2005": "2005"
        //                    , "2006": "2006"
        //                    , "2007": "2007"
        //                    , "2008": "2008"
        //                    , "2009": "2009"
        //                    , "2010": "2010"
        //                    , "2011": "2011"
        //                    , "2012": "2012"
        //                    , "2013": "2013"
        //                }
        // Make a leaflet map with data here (including popups)


        var options = {
            center: [37.6, -85.3]
            , zoom: 4
            , dragging: true
            , zoomControl: true
        }
        var map = L.map('map', options);

        // would prefer to use the mapbox base layer
        var MapQuestOpen_OSM = L.tileLayer('http://otile{s}.mqcdn.com/tiles/1.0.0/{type}/{z}/{x}/{y}.{ext}', {
            type: 'map'
            , ext: 'jpg'
            , attribution: 'Tiles Courtesy of <a href="http://www.mapquest.com/">MapQuest</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            , subdomains: '1234'
        }).addTo(map);


        var myStyle = {
            "color": 'black'
            , "weight": 2
            , "opacity": 1
        };

        var highlightedStyle = {
            "color": 'yellow'
            , "weight": 1
            , "opacity": 1
        }

        var dataLayer, attribute = "year";


        function drawfeatures() {

            dataLayer = L.geoJson(routes, {


                style: function (feature) {

                    return {
                        color: '#949494'
                        , opacity: 1
                        , weight: 2
                    };
                }
            }).addTo(map);


            //                Do the same as above for the second dataset. This doesnt appear to be working correctly.
            dataLayer2 = L.geoJson(roadssample, {
                style: function (feature) {
                    return {
                        color: '#949494'
                        , opacity: 1
                        , weight: 2
                    }
                }
            }).addTo(map);


            dataLayer.bringToFront();

            drawInfo();


            //                need to add a mouseover listener here to show information about trips that are being hovered over



        };

        function changeStyle() {

            dataLayer.eachLayer(function (layer) {
                console.log(layer.feature.properties.year);

                if (layer.feature.properties.year === attribute) {
                    layer.setStyle({
                        color: 'yellow'
                        , weight: 2
                        , opacity: 1

                    })
                    layer.bringToFront();
                } else {
                    layer.setStyle({
                        color: '#949494'
                        , weight: 2
                        , opacity: 1
                    })

                }

            });

        } // end changeStyle




        //!!!add slider bar

        drawfeatures();
        createSliderUI();




        function createSliderUI() {
            // create a Leaflet control object and store a reference to it in a variable
            var sliderControl = L.control({
                position: 'bottom'
            });

            sliderControl.onAdd = function (map) {

                // select an existing DOM element with an id of "ui-controls"
                var slider = L.DomUtil.get("ui-controls");

                // when the user clicks on the slider element
                L.DomEvent.addListener(slider, 'mousedown', function (e) {

                    // prevent the click event from bubbling up to the map, this means when you click and move the slider it wont also drag the leaflet map around
                    L.DomEvent.stopPropagation(e);

                });

                // return the slider from the onAdd method
                return slider;
            }

            // add the control object containing our slider element to the map
            //                sliderControl.addTo(map);

            //select the year-slider form element
            $(".year-slider")
                //            when the slider is changed, call a function that updates the attribute value to the current year position, and then run the update map function to generate the map and legend again
                .on("input change", function () {

                    attribute = $(this).val();
                    changeStyle();

                });

        }

        function drawInfo() {
            var info = L.control({
                position: 'topleft'
            });

            info.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'info')
                return div;
            };


            info.addTo(map);
            $(".info").hide();

            dataLayer.eachLayer(function (layer) {
                layer.on('mouseover', function () {


                    updateInfo(this);

                    attribute = layer.feature.properties.year;

                    layer.setStyle({
                        color: 'yellow'
                        , weight: 2
                        , opacity: 1

                    })
                    layer.bringToFront();


                    $(".year-slider").val(attribute);

                });

                layer.on('mouseout', function () {
                    layer.setStyle({
                        color: '#949494'
                        , weight: 2
                        , opacity: 1
                    })
                })

            });

            dataLayer.on('mouseover', function () {
                $(".info").show();
            });
            dataLayer.on('mouseout', function () {
                $(".info").hide();
            });

        }

        function updateInfo(feature) {

            var props = feature.feature.properties.comment;

//            console.log(props);

            var html = "<h1>" + "Year: " + feature.feature.properties.year + "<h3>" + props

            $(".info").html(html);
            $(".side-panel").html(html);

            dataLayer.on('mouseover', function () {
                $(".info").show();
            })


        }

        //!!!update csv content

        //!!!add mouse over labels (or update side bar)
    </script>
</body>

</html>